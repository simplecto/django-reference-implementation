<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Files</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Uppy CSS -->
    <link href="https://releases.transloadit.com/uppy/v3.25.3/uppy.min.css" rel="stylesheet">

    <style>
        /* Uppy drag-drop customization */
        .uppy-Root {
            font-family: inherit;
        }
        .uppy-DragDrop-container {
            border: 2px dashed #d1d5db !important;
            border-radius: 0.5rem !important;
            transition: border-color 0.3s !important;
        }
        .uppy-DragDrop-container:hover {
            border-color: #3b82f6 !important;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <div class="max-w-4xl mx-auto px-4 py-12">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">File Upload</h1>
            <p class="text-gray-600 dark:text-gray-300">{{ endpoint.name }}</p>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="{% if message.tags == 'success' %}bg-green-100 border-green-400 text-green-700{% elif message.tags == 'error' or message.tags == 'danger' %}bg-red-100 border-red-400 text-red-700{% elif message.tags == 'warning' %}bg-yellow-100 border-yellow-400 text-yellow-700{% elif message.tags == 'info' %}bg-blue-100 border-blue-400 text-blue-700{% else %}bg-gray-100 border-gray-400 text-gray-700{% endif %} border-l-4 p-4 mb-4 relative" role="alert">
                    <p class="pr-8">{{ message }}</p>
                    <button type="button" class="absolute top-4 right-4 text-current opacity-50 hover:opacity-100" onclick="this.parentElement.remove()">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Status messages for uploads -->
        <div id="upload-status"></div>

        <!-- Uppy drag-drop area -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-10 mb-8">
            <div id="drag-drop-area"></div>
            <div class="uppy-ProgressBar mt-5" id="upload-progress"></div>
        </div>

        <!-- File list -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6" id="file-list-container">
            <div class="flex justify-between items-center mb-6">
                <h4 class="text-2xl font-semibold text-gray-900 dark:text-white">Uploaded Files <span id="file-count" class="text-gray-500 dark:text-gray-400">({{ files.count }})</span></h4>
                {% if user.is_authenticated and user.is_staff and files %}
                    <a href="{% url 'dataroom:download_endpoint_zip' endpoint_id=endpoint.id %}"
                       class="inline-flex items-center px-4 py-2 font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        Download All as Zip
                    </a>
                {% endif %}
            </div>
            <div id="file-list">
                {% if files %}
                    {% for file in files %}
                    <div class="flex justify-between items-center py-4 border-b border-gray-200 dark:border-gray-700 last:border-b-0" data-file-id="{{ file.id }}">
                        <div class="flex-grow">
                            <div class="font-medium text-gray-900 dark:text-white">{{ file.filename }}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                Uploaded {{ file.uploaded_at|date:"F d, Y g:i A" }} • {{ file.file_size_bytes|filesizeformat }}
                            </div>
                        </div>
                        <form method="post" action="{% url 'dataroom:delete_file' endpoint_id=endpoint.id file_id=file.id %}" style="display: inline;" class="delete-form">
                            {% csrf_token %}
                            <button type="submit" class="px-3 py-1.5 text-sm font-medium text-red-700 bg-white border border-red-700 rounded-lg hover:bg-red-100 dark:bg-gray-800 dark:text-red-400 dark:border-red-400 dark:hover:bg-gray-700"
                                    onclick="return confirm('Are you sure you want to delete {{ file.filename }}?');">
                                Delete
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8" id="no-files-message">
                        <p>No files uploaded yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Uppy JavaScript -->
    <script src="https://releases.transloadit.com/uppy/v3.25.3/uppy.min.js"></script>

    <script>
        // Get CSRF token from cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        // Initialize Uppy
        const uppy = new Uppy.Uppy({
            autoProceed: false,
            allowMultipleUploadBatches: true,
            restrictions: {
                // No restrictions - accept any file type and size
            }
        })
        .use(Uppy.DragDrop, {
            target: '#drag-drop-area',
            note: 'Drag and drop files here, or click to select'
        })
        .use(Uppy.ProgressBar, {
            target: '#upload-progress',
            hideAfterFinish: false
        })
        .use(Uppy.XHRUpload, {
            endpoint: '{% url "dataroom:ajax_upload" endpoint_id=endpoint.id %}',
            formData: true,
            fieldName: 'file',
            headers: {
                'X-CSRFToken': csrftoken
            },
            limit: 5  // Upload up to 5 files concurrently
        });

        // Show status message
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('upload-status');
            const alert = document.createElement('div');

            let bgColor, borderColor, textColor;
            if (type === 'success') {
                bgColor = 'bg-green-100'; borderColor = 'border-green-400'; textColor = 'text-green-700';
            } else if (type === 'danger') {
                bgColor = 'bg-red-100'; borderColor = 'border-red-400'; textColor = 'text-red-700';
            } else {
                bgColor = 'bg-blue-100'; borderColor = 'border-blue-400'; textColor = 'text-blue-700';
            }

            alert.className = `${bgColor} ${borderColor} ${textColor} border-l-4 p-4 mb-4 relative`;
            alert.innerHTML = `
                <p class="pr-8">${message}</p>
                <button type="button" class="absolute top-4 right-4 text-current opacity-50 hover:opacity-100" onclick="this.parentElement.remove()">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            `;
            statusDiv.appendChild(alert);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Format date
        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        // Add uploaded file to list
        function addFileToList(fileData) {
            const fileList = document.getElementById('file-list');
            const noFilesMessage = document.getElementById('no-files-message');

            // Remove "no files" message if it exists
            if (noFilesMessage) {
                noFilesMessage.remove();
            }

            // Create new file item
            const fileItem = document.createElement('div');
            fileItem.className = 'flex justify-between items-center py-4 border-b border-gray-200 dark:border-gray-700 last:border-b-0';
            fileItem.setAttribute('data-file-id', fileData.id);
            fileItem.innerHTML = `
                <div class="flex-grow">
                    <div class="font-medium text-gray-900 dark:text-white">${fileData.filename}</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        Uploaded ${formatDate(fileData.uploaded_at)} • ${formatFileSize(fileData.size)}
                    </div>
                </div>
                <form method="post" action="/upload/{{ endpoint.id }}/delete/${fileData.id}/" style="display: inline;" class="delete-form">
                    <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                    <button type="submit" class="px-3 py-1.5 text-sm font-medium text-red-700 bg-white border border-red-700 rounded-lg hover:bg-red-100 dark:bg-gray-800 dark:text-red-400 dark:border-red-400 dark:hover:bg-gray-700"
                            onclick="return confirm('Are you sure you want to delete ${fileData.filename}?');">
                        Delete
                    </button>
                </form>
            `;

            // Add to top of list
            fileList.insertBefore(fileItem, fileList.firstChild);

            // Update file count
            const currentCount = fileList.querySelectorAll('[data-file-id]').length;
            document.getElementById('file-count').textContent = `(${currentCount})`;
        }

        // Handle successful upload
        uppy.on('upload-success', (file, response) => {
            if (response.body && response.body.file) {
                addFileToList(response.body.file);
                showStatus(`File "${response.body.file.filename}" uploaded successfully!`, 'success');
            }
        });

        // Handle upload errors
        uppy.on('upload-error', (file, error, response) => {
            let errorMessage = 'Error uploading file';
            if (response && response.body && response.body.error) {
                errorMessage = response.body.error;
            } else if (error) {
                errorMessage = error.message || errorMessage;
            }
            showStatus(`${errorMessage}`, 'danger');
        });

        // Handle complete batch
        uppy.on('complete', (result) => {
            if (result.successful.length > 0) {
                console.log('Upload complete:', result);
            }
        });

        // Auto-upload when files are added
        uppy.on('file-added', (file) => {
            uppy.upload();
        });
    </script>
</body>
</html>
